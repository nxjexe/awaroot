<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Awaroot</title>
    <button onclick="document.body.classList.toggle('dark'); localStorage.setItem('darkMode', document.body.classList.contains('dark'))">
        Dark Mode Toggle
    </button>
    <script>
        // Beim Laden prüfen
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
        }
    </script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; }
        form { margin-bottom: 40px; }
        label { display: block; margin: 10px 0 5px; }
        input[type="range"] { width: 100%; }
        .entries { border-top: 1px solid #ccc; padding-top: 20px; }
        .entry { margin: 10px 0; padding: 10px; background: #f8f8f8; }
        :root {
            --bg: white;
            --text: black;
            --entry-bg: #f8f8f8;
            --border: #ccc;
        }
        body.dark {
            --bg: #121212;
            --text: #e0e0e0;
            --entry-bg: #1e1e1e;
            --border: #333;
        }
        body {
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }
        input, textarea, button {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .entry {
            background: var(--entry-bg);
            border: 1px solid var(--border);
        }
        .entries {
            border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>
    <h1>Awaroot – dein Zustand</h1>
    
    {% if chart_json %}
    <h2>Trend</h2>
    <div id="chart-div" style="width:100%; height:400px; margin: 30px 0;"></div>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
        const fig = {{ chart_json | safe }};
        Plotly.newPlot('chart-div', fig.data, fig.layout, {responsive: true});
    </script>
    {% endif %}

    <p>Ein Eintrag pro Absenden – alles auf einen Blick.</p>
    <form method="post" id="main-form">
        <details> <!-- morgens offen -->
            <summary><strong>1. Vor der Session</strong></summary>
            
            <label>Sleep Score</label>
            <input type="number" name="sleep_score" min="0" max="100">

            <label>Schlafdauer</label>
            <input type="text" name="schlafdauer" placeholder="8h 24m">

            <label>HRV</label>
            <input type="number" name="hrv">

            <label>Rückengefühl (1–10)</label>
            <input type="range" name="ruecken" min="1" max="10" value="5">
            <span id="ruecken-value">5</span>

            <label>Schritte Vortag</label>
            <input type="number" name="schritte">

            <label>Gewicht (kg)</label>
            <input type="number" name="gewicht" step="0.1">

            <label>Selbstbehauptung (Freitext)</label>
            <textarea name="selbstbehauptung" rows="2" placeholder="Heute bleib ich dran..."></textarea>

            <button type="button" onclick="startSession()">Session starten</button>
        </details>

        <details id="during-section" style="display:none;">
            <summary><strong>2. Während der Session (wiederholt sich)</strong></summary>
            
            <label>Energie (1–10)</label>
            <input type="range" name="energie" min="1" max="10" value="5">
            <span id="energie-value">5</span>

            <label>Fokus (1–10)</label>
            <input type="range" name="fokus" min="1" max="10" value="5">
            <span id="fokus-value">5</span>

            <label>Gefühl (1–10)</label>
            <input type="range" name="gefuehl" min="1" max="10" value="5">
            <span id="gefuehl-value">5</span>

            <label>Gefühlsbeschreibung</label>
            <textarea name="gefuehls_text" rows="2"></textarea>

            <label>Kommentar</label>
            <textarea name="kommentar" rows="2"></textarea>

            <button type="submit">Zustand speichern & weiter</button>
        </details>

        <details id="after-section" style="display:none;">
            <summary><strong>3. Nach der Session</strong></summary>
            
            <label>Zufriedenheit (1–10)</label>
            <input type="range" name="zufriedenheit" min="1" max="10" value="5">
            <span id="zufriedenheit-value">5</span>

            <label>Boost</label>
            <textarea name="boost" rows="2"></textarea>

            <label>Bremse</label>
            <textarea name="bremse" rows="2"></textarea>

            <input type="hidden" name="stunden" id="stunden-hidden">

            <button type="submit">Abschließen & speichern</button>
        </details>

        <input type="datetime-local" name="custom_timestamp">
        <button type="button" id="stop-button" style="display:none;" onclick="stopSession()">Session stoppen</button>
    </form>

    <h2>Letzte Einträge</h2>
    <div class="entries">
        {% if recent_groups %}
            {% for ts, data in recent_groups %}
            <div class="entry">
                <strong>{{ ts }}</strong><br>
                {% if data.get('Zufriedenheit') is not none %}
                    Zufriedenheit Session: {{ data.get('Zufriedenheit') }}/10 <br>
                {% endif %}
                {% if data.get('Energie') is not none %}
                    Energie: {{ data.get('Energie', '-') }}/10 &nbsp;
                {% endif %}
                {% if data.get('Fokus') is not none %}
                    Fokus: {{ data.get('Fokus', '-') }}/10 &nbsp;
                {% endif %}
                {% if data.get('Gefühl') is not none %}
                    Gefühl: {{ data.get('Gefühl', '-') }}/10 <br>
                {% endif %}
                {% if data.get('Gefühlsbeschreibung') %}
                    Gefühlsbeschreibung: "{{ data.get('Gefühlsbeschreibung') }}" <br>
                {% endif %}
                {% if data.get('Sleep Score') is not none %}
                    Sleep Score: {{ data.get('Sleep Score', '-') }} &nbsp;
                {% endif %}
                {% if data.get('HRV') is not none %}
                    HRV: {{ data.get('HRV', '-') }} &nbsp;
                {% endif %}
                {% if data.get('Rückengefühl') is not none %}
                    Rückengefühl: {{ data.get('Rückengefühl', '-') }}/10 <br>
                {% endif %}
                {% if data.get('Schritte') is not none %}
                    Schritte: {{ data.get('Schritte', '-') }} &nbsp;
                {% endif %}
                {% if data.get('Gewicht') is not none %}
                    Gewicht: {{ data.get('Gewicht', '-') }} kg &nbsp;
                {% endif %}
                {% if data.get('Stunden gearbeitet') is not none %}
                    Stunden gearbeitet: {{ data.get('Stunden gearbeitet', '-') }} h <br>
                {% endif %}
                {% if data.get('Schlafdauer') %}
                    Schlafdauer: {{ data.get('Schlafdauer') }} <br>
                {% endif %}
                {% if data.get('Boost') %}
                    Motiviert: "{{ data.get('Boost') }}" <br>
                {% endif %}
                {% if data.get('Bremse') %}
                    Gebremst: "{{ data.get('Bremse') }}" <br>
                {% endif %}
                {% if data.get('Kommentar') %}
                    Kommentar: "{{ data.get('Kommentar') }}"
                {% endif %}
                <form method="post" action="/delete">
                    <input type="hidden" name="ts" value="{{ ts }}">
                    <button>Löschen</button>
                </form>
            </div>
            {% endfor %}
        {% else %}
            <p>Noch keine Einträge.</p>
        {% endif %}
    </div>

    <script>
    // --- Session UI State (persisted) ---
    // phases: before -> during -> after
    const KEY_PHASE = 'awaroot_phase';
    const KEY_START = 'awaroot_start_ms';

    const sec1 = document.querySelector('details:nth-of-type(1)'); // "Vor der Session"
    const sec2 = document.getElementById('during-section');
    const sec3 = document.getElementById('after-section');
    const stopBtn = document.getElementById('stop-button');

    function setDetailsVisible(detailsEl, visible, open) {
        if (!detailsEl) return;
        detailsEl.style.display = visible ? 'block' : 'none';
        if (visible) detailsEl.open = !!open;
    }

    function applyPhase(phase) {
        // default
        if (!phase) phase = 'before';

        if (phase === 'before') {
        setDetailsVisible(sec1, true, true);
        setDetailsVisible(sec2, false, false);
        setDetailsVisible(sec3, false, false);
        stopBtn.style.display = 'none';
        }

        if (phase === 'during') {
        setDetailsVisible(sec1, false, false);
        setDetailsVisible(sec2, true, true);   // offen bleiben
        setDetailsVisible(sec3, false, false);
        stopBtn.style.display = 'block';
        }

        if (phase === 'after') {
        setDetailsVisible(sec1, false, false);
        setDetailsVisible(sec2, false, false);
        setDetailsVisible(sec3, true, true);   // einmalig befüllen
        stopBtn.style.display = 'none';
        }

        localStorage.setItem(KEY_PHASE, phase);
    }

    function startSession() {
        // called by your button onclick="startSession()"
        const now = Date.now();
        localStorage.setItem(KEY_START, String(now));
        applyPhase('during');
    }

    function stopSession() {
        const startMs = parseInt(localStorage.getItem(KEY_START) || '0', 10);
        if (!startMs) return;

        const endMs = Date.now();
        const durationHours = (endMs - startMs) / (3600 * 1000);

        document.getElementById('stunden-hidden').value = durationHours.toFixed(2);

        applyPhase('after');
    }

    // Hook submits to keep/reset phase
    document.getElementById('main-form').addEventListener('submit', function(e) {
        const phase = localStorage.getItem(KEY_PHASE) || 'before';

        // If user saves during-session metrics -> stay in "during"
        if (phase === 'during') {
        applyPhase('during');
        return;
        }

        // If user finishes after-session -> reset to "before" for next time
        if (phase === 'after') {
        localStorage.removeItem(KEY_START);
        applyPhase('before');
        return;
        }

        // phase before: if they submit somehow, keep before
        applyPhase('before');
    });

    window.addEventListener('load', function() {
        // restore phase
        applyPhase(localStorage.getItem(KEY_PHASE) || 'before');
    });

    // --- Slider live values (keep your existing code) ---
    document.querySelectorAll('input[type=range]').forEach(slider => {
        const output = document.getElementById(slider.name + '-value');
        if (output) {
        output.textContent = slider.value;
        slider.addEventListener('input', () => output.textContent = slider.value);
        }
    });
    </script>

</body>
</html>